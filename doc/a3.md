https://github.com/servo/servo/issues/21254

# CSC302 Assignment 3: Good First Bug â€“ PerformanceResourceTiming: startTime

## Diagnosis

### Summary

**The time when an HTTP fetch is started is not stored,**
**as it should be according the W3C specifications, to be used for performance timing reasons.**

The `start_time` property in the `PerformanceResourceTiming` struct is not being set,
as [defined](https://w3c.github.io/resource-timing/#dfn-starttime)
in the [W3C Resource Timing Level 2 document](https://w3c.github.io/resource-timing/).

The issue's description states that this value should be
equal to either `fetch_start` or `redirect_start`,
as stated on the linked specification.

### Diagnosing for a Solution

According to the issue's description,
this value should be set in the `http_loader::http_fetch` method.
This method follows the standards [defined](https://fetch.spec.whatwg.org/#http-fetch)
in the [WHATWG Fetch Living Standard document](https://fetch.spec.whatwg.org).

A more precise definition of what the value of the property should be
is stated in the [linked specification](https://w3c.github.io/resource-timing/#dfn-starttime).
This specification states the following:

> The `startTime` attribute MUST return a `DOMHighResTimeStamp` [HR-TIME-2]
> with the time immediately before the user agent starts to queue the resource for fetching.
> If there are HTTP redirects or equivalent when fetching the resource,
> and if the timing allow check algorithm passes,
> this attribute MUST return the same value as `redirectStart`.
> Otherwise, this attribute MUST return the same value as `fetchStart`.

Due to some issues related to `PerformanceResourceTiming` values
incorrectly stating the value should be set in `http_loader::http_fetch`
(see [this comment](https://github.com/servo/servo/pull/22319#discussion_r238472138) on #22319
and [this comment](https://github.com/servo/servo/pull/22561#discussion_r247711219) on #22561),
it is possible that this value should not be set there either.

Since the specification for when the value should be set to `redirect_start`
is exactly the same as when
[`redirect_start`](https://w3c.github.io/resource-timing/#dom-performanceresourcetiming-redirectstart)
should be set to a non-zero value,
`start_time` should presumably be set in the same place.
In the "otherwise" case, the value of `start_time` should be set to `fetch_start`,
presumably in the same place as the latter is set.
Analyzing the files changed
for the [`fetch_start` PR](https://github.com/servo/servo/pull/22714/files)
and the [`redirect_start` PR](https://github.com/servo/servo/pull/22319/files),
it can easily be determined where these places are.

Analyzing this code,
its visible that these values are stored in a
[`ResourceFetchTiming` struct](https://github.com/servo/servo/blob/d9b76ef7d0ffc87d3b787def3735223f41987cf4/components/net_traits/lib.rs#L444)
during the HTTP fetch.
Later, these values are read into the
[`PerformanceEntry` struct](https://github.com/servo/servo/blob/5da10694912fa43b673f74445f4f249eaf46b451/components/script/dom/performanceentry.rs#L15),
and consequently the
[`PerformanceResourceTiming` struct](https://github.com/servo/servo/blob/d9b76ef7d0ffc87d3b787def3735223f41987cf4/components/script/dom/performanceresourcetiming.rs#L37)
(as this struct has `PerformanceEntry` as a property).

The `start_time` property already exists in the `PerformanceEntry` struct,
so it only has to be added to the `ResourceFetchTiming` struct.
Code related to this property also must be consequently added to the
[type implementation for `ResourceFetchTiming`](https://github.com/servo/servo/blob/d9b76ef7d0ffc87d3b787def3735223f41987cf4/components/net_traits/lib.rs#L480),
more specifically the `match` statement
(a [Rust case-like statement](https://doc.rust-lang.org/1.15.1/book/match.html) that must be exhaustive) in the
[`set_attribute` method](https://github.com/servo/servo/blob/d9b76ef7d0ffc87d3b787def3735223f41987cf4/components/net_traits/lib.rs#L494).

### Additional Requirements

According to [this commment](https://github.com/servo/servo/issues/21254#issuecomment-458547366)
by Josh Matthews, a `set_attribute_from` function should be added to `ResourceFetchTiming` type implementation,
which would take two `ResourceAttribute`s, and set the value of the first to the value of the second.
This would exist in addition to the existing
[`set_attribute` function](https://github.com/servo/servo/blob/d9b76ef7d0ffc87d3b787def3735223f41987cf4/components/net_traits/lib.rs#L494).

## Solution

1. The `start_time` property must be added to the `ResourceFetchTiming` struct,
   where it will be stored during the HTTP fetch process.

   ```rust
   // components/net_traits/lib.rs

   impl ResourceFetchTiming {
       pub fn new(timing_type: ResourceTimingType) -> ResourceFetchTiming {
           ResourceFetchTiming {
               timing_type: timing_type,
               redirect_count: 0,
               request_start: 0,
               response_start: 0,
               fetch_start: 0,
               start_time: 0,          // <-- Added here.
               redirect_start: 0,
           }
    }
   ```

2. The `start_time` property must be added to the `ResourceAttribute` enum,
   as this is used to interface with all values in the `ResourceFetchTiming` struct.

   ```rust
   // components/net_traits/lib.rs

   pub enum ResourceAttribute {
       RedirectCount(u16),
       RequestStart,
       ResponseStart,
       RedirectStart(RedirectStartValue),
       StartTime,                  // <-- Added here.
       FetchStart,
   }
   ```

3. The `start_time` attribute must also be set in the initialization of the struct,
   in the `ResourceFetchTiming` type implementation,
   and in the `match` statement of the `set_attribute` method.

    ```rust
   // components/net_traits/lib.rs

    impl ResourceFetchTiming {
        pub fn new(timing_type: ResourceTimingType) -> ResourceFetchTiming {
            ResourceFetchTiming {
                timing_type: timing_type,
                redirect_count: 0,
                request_start: 0,
                response_start: 0,
                fetch_start: 0,
                start_time: 0,      // <-- Added here.
                redirect_start: 0,
            }
        }

        pub fn set_attribute(&mut self, attribute: ResourceAttribute) {
            match attribute {
                ResourceAttribute::RedirectCount(count) => self.redirect_count = count,
                ResourceAttribute::RequestStart => self.request_start = precise_time_ns(),
                ResourceAttribute::ResponseStart => self.response_start = precise_time_ns(),
                ResourceAttribute::RedirectStart(val) => match val {
                    RedirectStartValue::Zero => self.redirect_start = 0,
                    RedirectStartValue::FetchStart => {
                        if self.redirect_start == 0 {
                            self.redirect_start = self.fetch_start
                        }
                    },
                },
                ResourceAttribute::StartTime => self.start_time = precise_time_ns(), // <-- Added here.
                ResourceAttribute::FetchStart => self.fetch_start = precise_time_ns(),
            }
        }
    }
    ```

4. For the additional requirement stated by Josh Matthews,
   the `set_attribute_from` function should also be
   added to the `ResourceFetchTiming` type implementation.

   ```rust
   // components/net_traits/lib.rs

   // This function was added.
   pub fn set_attribute_from(&mut self, attribute: ResourceAttribute, from: ResourceAttribute) {
        let value = match from {
            ResourceAttribute::RedirectCount(_) => self.redirect_count as u64,
            ResourceAttribute::RequestStart => self.request_start,
            ResourceAttribute::ResponseStart => self.response_start,
            ResourceAttribute::RedirectStart(_) => self.redirect_start,
            ResourceAttribute::StartTime => self.start_time,
            ResourceAttribute::FetchStart => self.fetch_start,
        };
        match attribute {
            ResourceAttribute::RedirectCount(_) => self.redirect_count = value as u16,
            ResourceAttribute::RequestStart => self.request_start = value,
            ResourceAttribute::ResponseStart => self.response_start = value,
            ResourceAttribute::RedirectStart(_) => self.redirect_start = value,
            ResourceAttribute::StartTime => self.start_time = value,
            ResourceAttribute::FetchStart => self.fetch_start = value,
        }
   }
   ```

5. Then, the value of `start_time` should be set to `fetch_start`
   at the same time as the latter is set for the first time.

   ```rust
   // components/net/http_loader.rs

   /// [Fetch](https://fetch.spec.whatwg.org#concept-fetch)
   pub fn fetch(request: &mut Request, target: Target, context: &FetchContext) {
       // Step 7 of https://w3c.github.io/resource-timing/#processing-model
       context
           .timing
           .lock()
           .unwrap()
           .set_attribute(ResourceAttribute::FetchStart);
       context // This statement was added.
           .timing
           .lock()
           .unwrap()
           .set_attribute_from(ResourceAttribute::StartTime, ResourceAttribute::FetchStart);
       fetch_with_cors_cache(request, &mut CorsCache::new(), target, context);
   }
   ```

6. Finally, the value of `start_time` should be set to `redirect_start`
   at the same time as when the latter is set.

   ```rust
   // components/net/fetch/methods.rs

   /// [HTTP redirect fetch](https://fetch.spec.whatwg.org#http-redirect-fetch)
    pub fn http_redirect_fetch(/* ... */) -> Response {

       /* ... other code ... */

       // Step 1 of https://w3c.github.io/resource-timing/#dom-performanceresourcetiming-fetchstart
       // TODO: check origin and timing allow check
       context
           .timing
           .lock()
           .unwrap()
           .set_attribute(ResourceAttribute::RedirectStart(
               RedirectStartValue::FetchStart,
           ));

       context // Statement below was added.
           .timing
           .lock()
           .unwrap()
           .set_attribute_from(ResourceAttribute::StartTime,
                               ResourceAttribute::RedirectStart(RedirectStartValue::Zero));

        /* ... other code ... */
   }
   ```

7. The `TODO` line regarding this issue should be removed from the `performanceresourcetiming.rs`.

   ```rust
   // components/script/dom/performanceresourcetiming.rs

   // TODO(#21254): startTime       <-- This line was removed.
   ```

## Testing

This fix can be simply tested by adding a print a print statement that
indicates whether `start_time` is set to `fetch_start` or `redirect_start`.

A print line can be added after both instances where the `start_time` is set, e.g.:

```rust
println!("start_time set to fetch_start");
```

Then, Servo can be built and tested.

To test whether `start_time` is appropriately set to `fetch_start` we can use a URL that we know that
does not redirect, e.g. http://www.google.com:

```bash
./mach run -d -- http://www.google.com/
```

We then observe the following output
(not that start time is set multiple times
because other resources other than the page itself are fetched):

```powershell
(servoenv) PS C:\code\csc302-servo> .\mach run -d -- http://www.google.com
**********************************************************************
** Visual Studio 2017 Developer Command Prompt v15.0
** Copyright (c) 2017 Microsoft Corporation
**********************************************************************
[vcvarsall.bat] Environment initialized for: 'x64'
start_time set to fetch_start
start_time set to fetch_start
start_time set to fetch_start
start_time set to fetch_start
start_time set to fetch_start
start_time set to fetch_start
start_time set to fetch_start
start_time set to fetch_start
start_time set to fetch_start
start_time set to fetch_start
start_time set to fetch_start
start_time set to fetch_start
start_time set to fetch_start
start_time set to fetch_start
start_time set to fetch_start
start_time set to fetch_start
start_time set to fetch_start
start_time set to fetch_start
start_time set to fetch_start
start_time set to fetch_start
```

To test whether `start_time` is appropriately set to `redirect_start`
we can use a URL that we know that does redirectm, e.g. https://acorn.utoronto.ca/
(it redirects to the log-in page):

```bash
./mach run -d -- https://acorn.utoronto.ca/
```

We then observe the following results
(not that start time is set to redirect time multiple times as there is multiple redirects):

```powershell
(servoenv) PS C:\code\csc302-servo> .\mach run -d -- http://www.google.com
**********************************************************************
** Visual Studio 2017 Developer Command Prompt v15.0
** Copyright (c) 2017 Microsoft Corporation
**********************************************************************
[vcvarsall.bat] Environment initialized for: 'x64'
start_time set to fetch_start
start_time set to redirect_start
start_time set to redirect_start
start_time set to redirect_start
start_time set to fetch_start
start_time set to fetch_start
start_time set to fetch_start
start_time set to fetch_start
start_time set to fetch_start
start_time set to fetch_start
start_time set to fetch_start
start_time set to fetch_start
start_time set to fetch_start
start_time set to fetch_start
```

![](start-time-redirect.jpg)
